---
title: "Analyses by Marian: Figures 1, 3, & 4" 
author: "Marian L. Schmidt, marschmi@umich.edu, @micro_marian"
date: "`r format(Sys.time(), '%Y %B, %d')`"
output:
  html_document:
    code_folding: show
    highlight: default
    keep_md: no
    theme: journal
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: yes
      toc_depth: 3
editor_options: 
  chunk_output_type: console
---
<style>
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll !important;
  word-break: keep-all !important;
  word-wrap: initial !important;
}
</style>


```{r setup, include=FALSE}
# For width of code chunks and scroll bar 
options(width=250)

knitr::opts_chunk$set(eval = TRUE, 
                      echo = TRUE, 
                      cache = FALSE,
                      include = TRUE,
                      warning = FALSE,
                      collapse = FALSE,
                      message = FALSE,
                      units = "in",
                      dpi = 500,
                      engine = "R", # Chunks will always have R code, unless noted
                      error = TRUE,
                      fig.path="Analysis_Figures/",  # Set the figure options
                      fig.align = "center", 
                      fig.width = 7, 
                      fig.height = 7,
                      dev=c('png', 'tiff'))

```

# Load Libraries & Set Themes
```{r load-libraries, message = FALSE, warning = FALSE}
library(devtools)   # Reproducibility (see end of file)
library(phyloseq)   # Easier data manipulation  
library(tidyverse)  # Pretty plotting and data manipulation 
library(forcats)    # Recoding factors
library(cowplot)    # Multiple plotting
library(d3heatmap)  # For nice heatmaps
library(phytools)   # Working with phylogenetic trees
library(ggtree)     # Pretty ggplot-esque phylogenetic trees
library(ape)        # Working with phylogenetic trees
library(DT)         # Pretty Tables 
library(gplots)     # Heatmap.2 function
library(stringr)    # To replace zeros in OTU names
library(adephylo)   # Testing phylogenetic autocorrelation
library(geiger)     # Phylogenetic signal 
source("code/set_colors.R")           # Set Colors for plotting

# Set some global ggplot parameters
mytheme <- theme(legend.text = element_text(size = 8), legend.title = element_text(size = 8, face = "bold"), 
                 plot.title = element_text(size = 10), legend.position = c(0.01, 0.9),
                 axis.title = element_text(size = 10, face = "bold"), axis.text = element_text(size = 8),
                 legend.key.width=unit(0.1,"line"), legend.key.height=unit(0.1,"line")) 
```


# Load FCM Data
```{r load-data, eval = TRUE}
# Read in the data 
raw_data <- read.table(file="data/Chloroplasts_removed/old/nochloro_HNA_LNA.tsv", header = TRUE) %>%
  mutate(norep_filter_name = paste(substr(Sample_16S,1,4), substr(Sample_16S,6,9), sep = "")) %>%
  arrange(norep_filter_name)

# Subset out only the Muskegon and Surface samples 
muskegon_data <- raw_data %>%
  dplyr::filter(Lake == "Muskegon" & Depth == "Surface") %>%
  dplyr::select(norep_filter_name)

# Load in the productivity data
production <- read.csv(file="data/production_data.csv", header = TRUE) %>%    
  dplyr::filter(fraction == "Free" & limnion == "Surface") %>%                         # Select only rows that are free-living
  dplyr::select(names, tot_bacprod, SD_tot_bacprod) %>%         # Select relevant columns for total productivity
  mutate(tot_bacprod = round(tot_bacprod, digits = 2),          # Round to 2 decimals
         SD_tot_bacprod = round(SD_tot_bacprod, digits = 2) ) %>%      
  dplyr::rename(norep_filter_name = names) %>%                  # Rename to match other data frame
  arrange(norep_filter_name)

# Stop if the names do not match
stopifnot(muskegon_data$norep_filter_name == production$norep_filter_name)

# Combine the two muskegon data frames into one
combined_data <- left_join(muskegon_data, production, by = "norep_filter_name")

# Merge the combined data back into the original data frame (data)
data <- left_join(raw_data, combined_data, by = "norep_filter_name") %>%
  dplyr::select(-c(Platform, Fraction)) %>%
  mutate(Lake = factor(Lake, levels = c("Michigan","Inland", "Muskegon")))
head(data)

# Fix the metadata
data$Month[data$Month == "Januari"] <- "June"
data$Season[data$Season == "Winter"] <- "Summer"
data$Lake[data$Site == "MLB"] <- "Muskegon"

# Write out the file 
#write.table(data, file="data/Chloroplasts_removed/productivity_data.tsv", row.names=TRUE)

####### HELPFUL TRANSFORMED AND SUBSETTED DATA
##### Subset Muskegon Lake Data Only 
muskegon <- dplyr::filter(data, Lake == "Muskegon" & Depth == "Surface") %>%
  mutate(Site = factor(Site, levels = c("MOT", "MDP", "MBR", "MIN"))) %>%
  filter(tot_bacprod < 90)

# Gather the data for summary statistics 
df_cells <- data %>%
  dplyr::select(1:4, Lake, Season:Depth) %>%
  rename(Total = Total.cells, HNA = HNA.cells, LNA = LNA.cells) %>%
  gather(key = FCM_type, value = num_cells, Total:LNA)
```

# Summary & Descriptive Statistics
```{r}
# Number of cells in HNA and LNA across all samples 
    # For a plot of these values, see figure 1 below
df_cells %>%
  group_by(FCM_type) %>%
  summarise(num_samples = n(),
            mean_cells = round(mean(num_cells), digits = 2),
            sd_mean_cells = round(sd(num_cells), digits = 2),
            median_cells = round(median(num_cells), digits = 2)) %>%
  datatable(caption = "Mean and median number of cells per ecosystem", rownames = FALSE)

# Are there more total cells in one lake over the other?
totcells_df <- df_cells %>%
  filter(FCM_type == "Total")
# Compute the analysis of variance
totcells_aov <- aov(num_cells ~ Lake, data = totcells_df)
summary(totcells_aov) # there is a difference, but which lake?
# Which samples are significant from each other?
TukeyHSD(totcells_aov) # Michigan is significantly different form Muskegon and Inland 

# Number of cells in HNA and LNA per ecosystem
df_cells %>%
  group_by(Lake, FCM_type) %>%
  summarise(num_samples = n(),
            mean_cells = round(mean(num_cells), digits = 2),
            median_cells = round(median(num_cells), digits = 2)) %>%
  datatable(caption = "Mean and median number of cells per ecosystem", rownames = FALSE)

# Proportion of HNA and LNA across all samples 
df_cells %>%
  dplyr::select(samples, Lake, FCM_type, num_cells) %>%
  spread(FCM_type, num_cells) %>%
  mutate(prop_HNA = HNA/Total * 100,
         prop_LNA = LNA/Total * 100) %>%
  dplyr::select(Lake, prop_HNA, prop_LNA) %>%
  summarize(mean_HNA = round(mean(prop_HNA), digits = 2), 
            sd_HNA = round(sd(prop_HNA), digits = 2),
            mean_LNA = round(mean(prop_LNA), digits = 2),
            sd_LNA = round(sd(prop_LNA), digits = 2))

# Proportion of HNA and LNAper ecosystem
prop_stats <- df_cells %>%
  dplyr::select(samples, Lake, FCM_type, num_cells) %>%
  spread(FCM_type, num_cells) %>%
  mutate(prop_HNA = HNA/Total * 100,
         prop_LNA = LNA/Total * 100) %>%
  dplyr::select(Lake, prop_HNA, prop_LNA) %>%
  rename(HNA = prop_HNA, LNA = prop_LNA) %>%
  group_by(Lake) %>%
  summarize(mean_HNA = round(mean(HNA), digits = 2),
            mean_LNA = round(mean(LNA), digits = 2),
            min_HNA = round(min(HNA), digits = 2), 
            max_HNA = round(max(HNA), digits = 2), 
            min_LNA = round(min(LNA), digits = 2), 
            max_LNA = round(max(LNA), digits = 2), 
            num_samples = n())

datatable(prop_stats, caption = "Statistics of the percentage of each flow cytometry group across the systems", rownames = FALSE)
```

## Number of cells per system
```{r cell-num-boxplot, fig.width = 3, fig.height = 2.75}
# Load in the data from each lake 
musk_all_df <- read.table(file="data/Chloroplasts_removed/ByLake_Filtering/5in10/muskegon/muskegon_sampledata_5in10.tsv", header = TRUE) %>%
  mutate(norep_filter_name = paste(substr(Sample_16S,1,4), substr(Sample_16S,6,9), sep = "")) %>%
  arrange(norep_filter_name)

mich_all_df <- read.table(file="data/Chloroplasts_removed/ByLake_Filtering/5in10/michigan/michigan_sampledata_5in10.tsv", header = TRUE) %>%
  mutate(norep_filter_name = paste(substr(Sample_16S,1,4), substr(Sample_16S,6,9), sep = "")) %>%
  arrange(norep_filter_name)

inla_all_df <- read.table(file="data/Chloroplasts_removed/ByLake_Filtering/5in10/inland/inland_sampledata_5in10.tsv", header = TRUE) %>%
  mutate(norep_filter_name = paste(substr(Sample_16S,1,4), substr(Sample_16S,6,9), sep = "")) %>%
  arrange(norep_filter_name)

stopifnot(colnames(musk_all_df) == colnames(mich_all_df))
stopifnot(colnames(musk_all_df) == colnames(inla_all_df))

lakes <- bind_rows(musk_all_df, mich_all_df, inla_all_df)

ggplot(df_cells, aes(x = FCM_type, y = num_cells, fill = Lake, color = Lake, shape = Lake)) + 
  geom_point(size = 1.5, position = position_jitterdodge(), color = "black") + 
  geom_boxplot(alpha = 0.7, outlier.shape = NA, show.legend = FALSE, color = "black") +
  scale_color_manual(values = lake_colors,  guide = "none") +
  scale_fill_manual(values = lake_colors) +
  scale_shape_manual(values = lake_shapes) +
  labs(y = "Number of Cells (cells/mL)", x = "FCM Type") +
  mytheme + theme(legend.title = element_blank(), legend.position = c(0.01, 0.95)) +
  guides(colour = guide_legend(override.aes = list(size=2.5)),
         shape = guide_legend(override.aes = list(size=2.5)),
         fill = guide_legend(override.aes = list(size=2.5)))
```


# Figure 1
```{r fig1, fig.width = 7, fig.height = 5.75}
########################  Analysis of HNA/LNA/Total Cells vs Total Productivity
# 1. Run the linear model 
lm_HNA <- lm(tot_bacprod ~ HNA.cells, data = muskegon)
summary(lm_HNA) # Linear model for HNA cells vs bacterial production 

## 2. Extract the R2 and p-value from the linear model: 
lm_HNA_stats <- paste("atop(R^2 ==", round(summary(lm_HNA)$adj.r.squared, digits = 2), ",",
                                    "p ==", round(unname(summary(lm_HNA)$coefficients[,4][2]), digits = 5), ")")

# 3. Plot it
HNA_vs_prod <- ggplot(muskegon, aes(x = HNA.cells, y = tot_bacprod)) + 
  geom_errorbarh(aes(xmin = HNA.cells - HNA.sd, xmax = HNA.cells + HNA.sd), color = "grey", alpha = 0.8) + 
  geom_errorbar(aes(ymin = tot_bacprod - SD_tot_bacprod, max = tot_bacprod + SD_tot_bacprod), color = "grey", alpha = 0.8) + 
  geom_point(size = 2, shape = 22, fill = "deepskyblue4") + 
  geom_smooth(method = "lm", color = "deepskyblue4") + 
  labs(y = "Bacterial Production \n (μg C/L/day)", x = "HNA Cell Density \n(cells/mL)") +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE), 
                     breaks = c(2e+06, 3e+06)) +
  annotate("text", x=1.65e+06, y=60, label=lm_HNA_stats, parse = TRUE, color = "black", size = 3) +
  mytheme

# 1. Run the linear model 
lm_LNA <- lm(tot_bacprod ~ LNA.cells, data = muskegon)
summary(lm_LNA) # Linear model for LNA cells vs bacterial production 

## 2. Extract the R2 and p-value from the linear model: 
lm_LNA_stats <- paste("atop(R^2 ==", round(summary(lm_LNA)$adj.r.squared, digits = 3), ",",
                      "p ==", round(unname(summary(lm_LNA)$coefficients[,4][2]), digits = 2), ")")

# 3. Plot it
LNA_vs_prod <- ggplot(muskegon, aes(x = LNA.cells, y = tot_bacprod)) + 
  geom_errorbarh(aes(xmin = LNA.cells - LNA.sd, xmax = LNA.cells + LNA.sd), color = "grey", alpha = 0.8) + 
  geom_errorbar(aes(ymin = tot_bacprod - SD_tot_bacprod, max = tot_bacprod + SD_tot_bacprod), color = "grey", alpha = 0.8) + 
  geom_point(size = 2.5, shape = 22, fill = "darkgoldenrod1") + 
  labs(y = "Bacterial Production \n (μg C/L/day)", x = "LNA Cell Density \n(cells/mL)") +
  #geom_smooth(method = "lm", se = FALSE, linetype = "longdash", color = "darkgoldenrod1") + 
  annotate("text", x=2.75e+06, y=60, label=lm_LNA_stats, parse = TRUE, color = "red", size = 3) +
  mytheme

# 1. Run the linear model 
lm_total <- lm(tot_bacprod ~ Total.cells, data = muskegon)
summary(lm_total) # Linear model for total cells vs bacterial production 

## 2. Extract the R2 and p-value from the linear model: 
lm_total_stats <- paste("atop(R^2 ==", round(summary(lm_total)$adj.r.squared, digits = 2), ",",
                      "p ==", round(unname(summary(lm_total)$coefficients[,4][2]), digits = 2), ")")

# 3. Plot it 
Total_vs_prod <- ggplot(muskegon, aes(x = Total.cells, y = tot_bacprod)) + 
  geom_errorbarh(aes(xmin = Total.cells - Total.count.sd, xmax = Total.cells + Total.count.sd), color = "grey", alpha = 0.8) + 
  geom_errorbar(aes(ymin = tot_bacprod - SD_tot_bacprod, max = tot_bacprod + SD_tot_bacprod), color = "grey", alpha = 0.8) + 
  scale_shape_manual(values = lake_shapes) +
  geom_point(size = 2.5, shape = 22, fill = "black") + 
  labs(y = "Bacterial Production \n (μg C/L/day)", x = "Total Cell Density \n(cells/mL)") +
  geom_smooth(method = "lm", color = "black") + 
  #geom_smooth(method = "lm", se = FALSE, linetype = "longdash", color = "red") + 
  annotate("text", x=5.25e+06, y=60, label=lm_total_stats, parse = TRUE, color = "black", size = 3) +
  mytheme

###### ###### ###### ###### ###### ###### ###### ###### ###### ###### 
###### Correlation between HNA and LNA Across the three systems ###### 
## Is there a corrlation between HNA and LNA across ecosystems?
# 1. Run the linear model 
lm_allNA_corr <- lm(LNA.cells ~ HNA.cells, data = lakes)
summary(lm(LNA.cells ~ HNA.cells * Lake, data = lakes))

## 2. Extract the R2 and p-value from the linear model: 
lm_allNA_corr_stats <- paste("atop(R^2 ==", round(summary(lm_allNA_corr)$adj.r.squared, digits = 2), ",",
                          "p ==", round(unname(summary(lm_allNA_corr)$coefficients[,4][2]), digits = 24), ")")

# 3. Plot it
p2 <- ggplot(lakes, aes(x = HNA.cells, y = LNA.cells)) + 
  geom_errorbarh(aes(xmin = HNA.cells - HNA.sd, xmax = HNA.cells + HNA.sd), color = "grey", alpha = 0.8) + 
  geom_errorbar(aes(ymin = LNA.cells - LNA.sd, max = LNA.cells + LNA.sd), color = "grey", alpha = 0.8) + 
  geom_point(size = 2.5, alpha = 0.9, aes(fill = Lake, shape = Lake)) + 
  scale_fill_manual(values = lake_colors) +
  scale_shape_manual(values = lake_shapes) +
  geom_smooth(method = "lm", color = "black") + 
  labs(y = "LNA Cell Density (cells/mL)", x = "HNA Cell Density (cells/mL)") +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 6.1e+06)) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 1e+07)) +
  annotate("text", x=5e+06, y=0.8e+06, label=lm_allNA_corr_stats, parse = TRUE, color = "black", size = 3) +
  mytheme + theme(legend.position = "none") #theme(legend.title = element_blank(), legend.position = c(0.01, 0.95))

###### MAKE THE PLOT 
## Extract legends for plotting 
plot_for_legend <- 
  ggplot(df_cells, aes(x = Lake, y = num_cells, fill = FCM_type, color = FCM_type)) + 
  geom_point(size = 1, shape = 22, position = position_jitterdodge()) + 
  scale_fill_manual(values = fcm_colors) + 
  scale_color_manual(values = fcm_colors, guide = "none") + 
  scale_shape_manual(values = 22) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE)) +
  labs(y = "Number of Cells \n (cells/mL)", x = "Lake", fill = "FCM") +
  theme(legend.position = "right",
           legend.title = element_text(size = 12, face = "bold"), 
           legend.text = element_text(size = 12),
           legend.key.width=unit(1,"line"), 
           legend.key.height=unit(1,"line")) +
  guides(fill = guide_legend(override.aes = list(size=3.5)))

legend1 <- get_legend(plot_for_legend)

legend2 <- get_legend(p2 + theme(legend.position = "right",
           legend.title = element_text(size = 12, face = "bold"), 
           legend.text = element_text(size = 12),
           legend.key.width=unit(1,"line"), 
           legend.key.height=unit(1,"line")) +
  guides(fill = guide_legend(override.aes = list(size=3.5))))

# place the legends
legend_positions <- plot_grid(legend2, legend1, nrow = 2, ncol = 1)

# Place the legends next to figure 1A
row1 <- plot_grid(NULL, p2, legend_positions, 
                        labels = c("", "A", ""),
                        ncol = 3, nrow = 1,
                        rel_widths = c(0.5, 1, 0.5))

# Add Figures 1B, 1C, and 1D
row2 <- plot_grid(HNA_vs_prod + theme(legend.position = "none"), 
          LNA_vs_prod + theme(axis.title.y = element_blank(), legend.position = "none"), 
          Total_vs_prod + theme(axis.title.y = element_blank(), legend.position = "none"),
          labels = c("B", "C", "D"), 
          ncol = 3, nrow = 1, 
          rel_widths = c(0.95, 0.8, 0.8))

# Final Figure 1
plot_grid(row1, row2,
          nrow = 2, ncol = 1)
```

## Figure 1A: Plotted By Lake System
```{r perlake-HNALNA-corr, fig.width = 10, fig.height = 3.5}
### MUSKEGON ONLY ANALYSIS
# 1. Run the linear model 
lm_muskNA_corr <- lm(LNA.cells ~ HNA.cells, data = musk_all_df)

## 2. Extract the R2 and p-value from the linear model: 
lm_muskNA_corr_stats <- paste("atop(R^2 ==", round(summary(lm_muskNA_corr)$adj.r.squared, digits = 2), ",",
                             "p ==", round(unname(summary(lm_muskNA_corr)$coefficients[,4][2]), digits = 9), ")")

musk_corr_plot <- ggplot(musk_all_df, aes(x = HNA.cells, y = LNA.cells)) + 
  geom_errorbarh(aes(xmin = HNA.cells - HNA.sd, xmax = HNA.cells + HNA.sd), color = "grey") + 
  geom_errorbar(aes(ymin = LNA.cells - LNA.sd, max = LNA.cells + LNA.sd), color = "grey") + 
  geom_point(size = 3, shape = 22, aes(fill = Lake)) + 
  geom_smooth(method = "lm", color = "black") + 
  ggtitle("Muskegon Lake") + scale_fill_manual(values = lake_colors) +
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 6.1e+06)) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 1e+07)) +
  labs(y = "LNA Cell Density (cells/mL)", x = "HNA Cell Density (cells/mL)") +
  annotate("text", x=5e+06, y=0.8e+06, label=lm_muskNA_corr_stats, parse = TRUE, color = "black", size = 3) +
  mytheme

### INLAND ONLY ANALYSIS
# 1. Run the linear model 
lm_inlaNA_corr <- lm(LNA.cells ~ HNA.cells, data = filter(inla_all_df, Sample_16S != "Z14003F"))

## 2. Extract the R2 and p-value from the linear model: 
lm_inlaNA_corr_stats <- paste("atop(R^2 ==", round(summary(lm_inlaNA_corr)$adj.r.squared, digits = 2), ",",
                              "p ==", round(unname(summary(lm_inlaNA_corr)$coefficients[,4][2]), digits = 2), ")")

inla_corr_plot <- ggplot(filter(inla_all_df, Sample_16S != "Z14003F"), aes(x = HNA.cells, y = LNA.cells)) + 
  geom_errorbarh(aes(xmin = HNA.cells - HNA.sd, xmax = HNA.cells + HNA.sd), color = "grey") + 
  geom_errorbar(aes(ymin = LNA.cells - LNA.sd, max = LNA.cells + LNA.sd), color = "grey") + 
  geom_point(size = 3, shape = 22, aes(fill = Lake)) + 
  geom_smooth(method = "lm", color = "black") + 
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 6.1e+06)) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 1e+07)) +
  ggtitle("Inland Lakes") + scale_fill_manual(values = lake_colors) +
  labs(y = "LNA Cell Density (cells/mL)", x = "HNA Cell Density (cells/mL)") +
  annotate("text", x=5e+06, y=0.8e+06, label=lm_inlaNA_corr_stats, parse = TRUE, color = "black", size = 3) +
  mytheme

### MICHIGAN ONLY ANALYSIS
# 1. Run the linear model 
lm_michNA_corr <- lm(LNA.cells ~ HNA.cells, data = mich_all_df)

# Without the Lake Michigan outlier!
summary(lm(LNA.cells ~ HNA.cells, data = filter(mich_all_df, Sample_16S != "M15S2F515")))

## 2. Extract the R2 and p-value from the linear model: 
lm_michNA_corr_stats <- paste("atop(R^2 ==", round(summary(lm_michNA_corr)$adj.r.squared, digits = 2), ",",
                              "p ==", round(unname(summary(lm_michNA_corr)$coefficients[,4][2]), digits = 11), ")")

mich_corr_plot <- ggplot(mich_all_df, aes(x = HNA.cells, y = LNA.cells)) + 
  geom_errorbarh(aes(xmin = HNA.cells - HNA.sd, xmax = HNA.cells + HNA.sd), color = "grey") + 
  geom_errorbar(aes(ymin = LNA.cells - LNA.sd, max = LNA.cells + LNA.sd), color = "grey") + 
  geom_point(size = 3, shape = 22, aes(fill = Lake)) + 
  geom_smooth(method = "lm", color = "black") + 
  scale_x_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 6.1e+06)) +
  scale_y_continuous(labels = function(x) format(x, scientific = TRUE), limits = c(0, 1e+07)) +
  ggtitle("Lake Michigan") + scale_fill_manual(values = lake_colors) +
  labs(y = "LNA Cell Density (cells/mL)", x = "HNA Cell Density (cells/mL)") +
  annotate("text", x=5e+06, y=0.8e+06, label=lm_michNA_corr_stats, parse = TRUE, color = "black", size = 3) +
  mytheme

plot_grid(mich_corr_plot, inla_corr_plot, musk_corr_plot, 
          labels = c("A", "B", "C"), nrow = 1, ncol = 3)

# Which sample is the outlier? And how does it compare from the other top 3 samples?
mich_all_df %>% arrange(-Total.cells) %>% head(n=3)
```

## Figure 1B & 1D: Fraction HNA vs Productivity
```{r fracHNA-vs-prod, fig.width = 7, fig.height = 6.5}
## Plot the fraction of HNA
fmusk <- muskegon %>% 
  mutate(fHNA = HNA.cells/Total.cells,
         fLNA = LNA.cells/Total.cells)

lm_fHNA <- lm(tot_bacprod ~ fHNA, data = fmusk)

## 2. Extract the R2 and p-value from the linear model: 
lm_fHNA_stats <- paste("atop(R^2 ==", round(summary(lm_fHNA)$adj.r.squared, digits = 2), ",",
                      "p ==", round(unname(summary(lm_fHNA)$coefficients[,4][2]), digits = 3), ")")


fHNA_vs_prod <- ggplot(fmusk, aes(x = fHNA, y = tot_bacprod)) + 
  geom_errorbar(aes(ymin = tot_bacprod - SD_tot_bacprod, max = tot_bacprod + SD_tot_bacprod), color = "grey") + 
  geom_point(size = 3, aes(shape = Lake), fill = "deepskyblue4") + 
  geom_smooth(method = "lm", linetype = "longdash", color = "deepskyblue4") + 
  scale_x_continuous(limits = c(0.15, 0.9), breaks = seq(0.2, 0.9, by = 0.2)) + 
  ylab("Bacterial Production") + xlab("Fraction HNA") +
  scale_shape_manual(values = lake_shapes) + 
  annotate("text", x= 0.22, y=60, label=lm_fHNA_stats, parse = TRUE, color = "black", size = 3) +
  mytheme + theme(legend.position = "none")


### LNA Fraction
## Plot the fraction of HNA
lm_fLNA <- lm(tot_bacprod ~ fLNA, data = fmusk)

## 2. Extract the R2 and p-value from the linear model: 
lm_fLNA_stats <- paste("atop(R^2 ==", round(summary(lm_fLNA)$adj.r.squared, digits = 2), ",",
                      "p ==", round(unname(summary(lm_fLNA)$coefficients[,4][2]), digits = 3), ")")


fLNA_vs_prod <- ggplot(fmusk, aes(x = fLNA, y = tot_bacprod)) + 
  geom_errorbar(aes(ymin = tot_bacprod - SD_tot_bacprod, max = tot_bacprod + SD_tot_bacprod), color = "grey") + 
  geom_point(size = 3, aes(shape = Lake), fill = "darkgoldenrod1") + 
  geom_smooth(method = "lm", color = "darkgoldenrod1", fill = "darkgoldenrod1",  linetype = "longdash") + 
  scale_x_continuous(limits = c(0.15, 0.9), breaks = seq(0.2, 0.9, by = 0.2)) + 
  ylab("Bacterial Production") + xlab("Fraction LNA") +
  scale_shape_manual(values = lake_shapes) + 
  annotate("text", x= 0.22, y=60, label=lm_fLNA_stats, parse = TRUE, color = "black", size = 3) +
  mytheme + theme(legend.position = "none")

plot_grid(HNA_vs_prod + theme(legend.position = "none"), 
          fHNA_vs_prod,
          LNA_vs_prod, fLNA_vs_prod,
          labels = c("A", "B", "C", "D"), ncol = 2, nrow = 2,
          align = "h") 
```


# Figure 3: Heatmap
## Load RL Score data
```{r RL-scores}
# Read in Data
dfHNA_musk_scores <- read.csv("FS_final/Muskegon_fs_scores_HNA_5seq10.csv") %>%
  dplyr::filter(RL.score > 0.09) %>%
  mutate(Lake = "Muskegon")%>%
  rename(OTU = X, RL.score.HNA = RL.score) %>%
  dplyr::select(OTU, RL.score.HNA)

dfLNA_musk_scores <- read.csv("FS_final/Muskegon_fs_scores_LNA_5seq10.csv") %>%
  dplyr::filter(RL.score > 0.09) %>%
  mutate(Lake = "Muskegon") %>%
  rename(OTU = X, RL.score.LNA = RL.score) %>%
  dplyr::select(OTU, RL.score.LNA)

dfHNA_inland_scores <- read.csv("FS_final/Inland_fs_scores_HNA_5seq10.csv") %>%
  dplyr::filter(RL.score > 0.13) %>%
  mutate(Lake = "Inland")%>%
  rename(OTU = X, RL.score.HNA = RL.score) %>%
  dplyr::select(OTU, RL.score.HNA)

dfLNA_inland_scores <- read.csv("FS_final/Inland_fs_scores_LNA_5seq10.csv") %>%
  dplyr::filter(RL.score > 0.108) %>%
  mutate(Lake = "Inland") %>%
  rename(OTU = X, RL.score.LNA = RL.score) %>%
  dplyr::select(OTU, RL.score.LNA)

dfHNA_michigan_scores <- read.csv("FS_final/Michigan_fs_scores_HNA_5seq10.csv") %>%
  dplyr::filter(RL.score > 0.248) %>%
  mutate(Lake = "Michigan")%>%
  rename(OTU = X, RL.score.HNA = RL.score) %>%
  dplyr::select(OTU, RL.score.HNA)

dfLNA_michigan_scores <- read.csv("FS_final/Michigan_fs_scores_LNA_5seq10.csv") %>%
  dplyr::filter(RL.score > 0.286) %>%
  mutate(Lake = "Michigan") %>%
  rename(OTU = X, RL.score.LNA = RL.score) %>%
  dplyr::select(OTU, RL.score.LNA)

# Combine HNA and LNA datasets together
muskegon_df_scores <- full_join(dfHNA_musk_scores, dfLNA_musk_scores, by = "OTU") %>%
  rename(Muskegon_HNA = RL.score.HNA, Muskegon_LNA = RL.score.LNA) # Rename the column to have the lake and FCM
inland_df_scores <- full_join(dfHNA_inland_scores, dfLNA_inland_scores, by = "OTU") %>%
  rename(Inland_HNA = RL.score.HNA, Inland_LNA = RL.score.LNA) # Rename the column to have the lake and FCM
michigan_df_scores <- full_join(dfHNA_michigan_scores, dfLNA_michigan_scores, by = "OTU") %>%
  rename(Michigan_HNA = RL.score.HNA, Michigan_LNA = RL.score.LNA) # Rename the column to have the lake and FCM

# Combine into a full dataset
df_RLscores <- 
  full_join(muskegon_df_scores, inland_df_scores, by = "OTU") %>%
  full_join(michigan_df_scores, by = "OTU") 
  
matrix_RLscores <- df_RLscores %>%
  tibble::column_to_rownames(var = "OTU") %>%
  as.matrix()

# Replace the NA values with 0 
matrix_RLscores[is.na(matrix_RLscores)] <- 0  
```

## Plot figure 3: RL Scores
```{r fig3-allOTUs, fig.width = 8, fig.height = 20}
breakers <- seq(min(matrix_RLscores, na.rm = T), max(matrix_RLscores, na.rm = T), length.out = 21)
my_palette <- colorRampPalette(c("white", "red")) (n=20)

# Set the colors of the different columns going in
colz <- c("#FF933F", "#FF933F", "#EC4863", "#EC4863", "#5C2849", "#5C2849")

heatmap.2(matrix_RLscores, 
          distfun = function(x) dist(x, method = "euclidean"),
          hclustfun = function(x) hclust(x,method = "complete"),
          col = my_palette, breaks = breakers, trace = "none",
          key = TRUE, symkey = FALSE, density.info = "none", srtCol = 30,
          margins=c(5.5,7), cexRow = 1.25,cexCol = 1.25,
          key.xlab = "RL Score",ColSideColors = colz,
          lhei = c(1,9))
```


### Top 10 from Fig 3 Scores
```{r fig3-top10-noclust, fig.width=6, fig.height=8}
# Extract the top 10 OTUs 
mich_top10_OTUs <- michigan_df_scores %>%
  top_n(., 10, Michigan_HNA) %>%
  dplyr::select(OTU)

inland_top10_HNA_OTUs <- inland_df_scores %>%
  dplyr::select(OTU, Inland_HNA) %>%
  top_n(., 10, Inland_HNA) %>%
  dplyr::select(OTU)

inland_top10_LNA_OTUs <- inland_df_scores %>%
  dplyr::select(OTU, Inland_LNA) %>%
  top_n(., 10, Inland_LNA) %>%
  dplyr::select(OTU) 
  
musk_top10_HNA_OTUs <- muskegon_df_scores %>%
  dplyr::select(OTU, Muskegon_HNA) %>%
  top_n(., 10, Muskegon_HNA) %>%
  dplyr::select(OTU)

musk_top10_LNA_OTUs <- muskegon_df_scores %>%
  dplyr::select(OTU, Muskegon_LNA) %>%
  top_n(., 10, Muskegon_LNA) %>%
  dplyr::select(OTU)

# The above code pulls out the OTUs and we'll match this with the data from the full dataset
df_OTUs <- bind_rows(mich_top10_OTUs, inland_top10_HNA_OTUs, inland_top10_LNA_OTUs, musk_top10_HNA_OTUs, musk_top10_LNA_OTUs) %>%
  unique()

# Do a filtering join 
df_top10 <- df_OTUs %>%
  left_join(df_RLscores, by = "OTU")

matrix_top10 <- df_top10 %>%
  # Remove the zeros in the OTU names 
  mutate(OTU = str_replace(OTU, "00", "")) %>%
  tibble::column_to_rownames(var = "OTU") %>%
  as.matrix()

# The heatmap won't work with NAs 
matrix_top10[is.na(matrix_top10)] <- 0

#png("Analysis_Figures/clustering_top10.png", units = "in", width = 6, height = 8, res = 300)

heatmap.2(matrix_top10, 
        distfun = function(x) dist(x, method = "euclidean"),
        hclustfun = function(x) hclust(x,method = "complete"),
        col = my_palette, breaks = breakers, trace = "none",
        key = TRUE, symkey = FALSE, density.info = "none", srtCol = 30,
        margins=c(5.5,7), cexRow = 1.25,cexCol = 1.25,
        key.xlab = "RL Score",ColSideColors = colz,
        lhei = c(1.5,9), key.title=NA)

#dev.off()

# WITHOUT the clustering!
heatmap.2(matrix_top10,
        dendrogram = "none", Rowv = FALSE, Colv = FALSE,
        col = my_palette, breaks = breakers, trace = "none",
        key = TRUE, symkey = FALSE, density.info = "none", srtCol = 30,
        margins=c(5.5,7), cexRow = 1.25,cexCol = 1.25,
        key.xlab = "RL Score",ColSideColors = colz,
        lhei = c(1,9), #lmat = rbind(1,2),
        key.title=NA)
```

```{r fig3-columns-only, fig.width=6, fig.height=8}
# Only cluster the columns
heatmap.2(matrix_top10, 
        distfun = function(x) dist(x, method = "euclidean"),
        hclustfun = function(x) hclust(x,method = "complete"),
        # Do not cluster based on rows
        dendrogram = "column",Rowv = FALSE, 
        col = my_palette, breaks = breakers, trace = "none",
        key = TRUE, symkey = FALSE, density.info = "none", srtCol = 30,
        margins=c(5.5,7), cexRow = 1.25,cexCol = 1.25,
        key.xlab = "RL Score",ColSideColors = colz,
        lhei = c(1.5,9), key.title=NA)
```


# Figure 4: Phylogenetic Tree
```{r fig4-all, fig.width=11, fig.height=18}
#### PHYLOGENETIC ANALYSIS
load("data/phyloseq.RData")
physeq.otu

# With all of the OTUs that pass the RL score threshold
otu_scores_df <- matrix_RLscores %>%
  as.data.frame() %>%
  tibble::rownames_to_column("OTU")

# Subset the vector with names of the OTUs
vector_of_otus <- as.vector(otu_scores_df$OTU)

# Write to a file
#write(vector_of_otus, file = "data/fasttree/Figure5/OTUnames_RLscores_258.txt",
#      ncolumns = 1, append = FALSE, sep = "\n")

physeq <- physeq.otu %>%
  subset_taxa(., taxa_names(physeq.otu) %in% vector_of_otus)  

# Which OTU is missing?
setdiff(sort(vector_of_otus), sort(taxa_names(physeq)))
setdiff(sort(taxa_names(physeq)), sort(vector_of_otus))

######################################### FASTTREE
fast_tree <- read.tree(file="data/Figure4/newick_tree_OTUs258.tre")

fast_tree_tip_order <- data.frame(fast_tree$tip.label) %>%
  rename(OTU = fast_tree.tip.label)

# Make sure the OTUs match 
stopifnot(sort(vector_of_otus)==sort(as.character(fast_tree_tip_order$OTU)))

fasttree_physeq <- merge_phyloseq(physeq, phy_tree(fast_tree))

# Fix the taxonomy names 
colnames(tax_table(fasttree_physeq)) <- c("Kingdom","Phylum","Class","Order","Family","Genus","Species")

###################################################################### ADD THE PROTEOBACTERIA TO THE PHYLA
phy <- data.frame(tax_table(fasttree_physeq))
Phylum <- as.character(phy$Phylum)
Class <- as.character(phy$Class)

for  (i in 1:length(Phylum)){ 
  if (Phylum[i] == "Proteobacteria"){
    Phylum[i] <- Class[i]  } }

phy$Phylum <- Phylum # Add the new phylum level data back to phy

t <- tax_table(as.matrix(phy))
tax_table(fasttree_physeq) <- t

fasttree_tax <- data.frame(tax_table(fasttree_physeq)) %>%
  tibble::rownames_to_column(var = "OTU")


## Let's root the tree
is.rooted(fast_tree)
rooted_tree <- root(fast_tree, outgroup = "Otu001533", resolve.root = TRUE)
is.rooted(rooted_tree) # Sanity Check

# Need to make a manual file based off of FIgure 4 - it starts with OTU names
# write.csv(df_RLscores, file = "data/fasttree/Figure5/OTUs258_MANUAL.csv", row.names = FALSE)
# Next I manually filled in the fcm_type and lake columns :/ 

phyfcm_fasttree_df <- read.csv("data/Figure4/OTUs258_MANUAL.csv") %>%
  left_join(., fasttree_tax, by = "OTU") %>%
  tibble::column_to_rownames("OTU") %>%
  dplyr::select(Phylum, FCM)

rooted_tree_plot <- 
  ggplot(rooted_tree, aes(x, y)) + geom_tree() + theme_tree() +
  geom_tiplab(size=3, align=TRUE, linesize=.5) #+
  #geom_nodelab(vjust=-.5, size=3) 

gheatmap(rooted_tree_plot, phyfcm_fasttree_df, offset = 0.1, width=0.3, font.size=3, colnames_angle=0, hjust=0.5) +
  scale_fill_manual(values = phylum_colors, 
                    breaks = c("Acidobacteria","Actinobacteria", "Alphaproteobacteria", "Bacteria_unclassified", "Bacteroidetes", "Betaproteobacteria", 
                               "Chlorobi", "Chloroflexi","Cyanobacteria","Deltaproteobacteria", "Epsilonproteobacteria", "Firmicutes", 
                               "Gammaproteobacteria","Gemmatimonadetes","Omnitrophica","Parcubacteria","Planctomycetes",
                               "Proteobacteria_unclassified", "TA18","unknown_unclassified", "Verrucomicrobia", 
                               # FCM Groups
                               "Both", "HNA", "LNA")) +
  guides(fill=guide_legend(ncol=1))
```


### Prepare files for iTOL - Figure 4
```{r iTOL, eval=FALSE}
OTU258_and_phylum <- read.csv("data/fasttree/Figure5/OTUs258_MANUAL.csv") %>%
  left_join(., fasttree_tax, by = "OTU") %>%
  dplyr::select(OTU, Phylum) 

OTU258_and_FCM <- read.csv("data/fasttree/Figure5/OTUs258_MANUAL.csv") %>%
  left_join(., fasttree_tax, by = "OTU") %>%
  dplyr::select(OTU, FCM) %>%
  rename(Phylum = FCM) # To extract from phylum_colors

itol_colors <- 
  phylum_colors %>%
  as.list() %>%
  as.matrix() %>%
  as.data.frame() %>%
  tibble::rownames_to_column("Phylum") %>%
  rename(color_name = V1) %>%
  mutate(hex = col2hex(color_name)) %>%
  dplyr::select(hex, Phylum)

itol_phylum_df <- left_join(OTU258_and_phylum, itol_colors, by = "Phylum") %>%
  mutate(itol_label = "range") %>%
  dplyr::select(OTU, itol_label, hex, Phylum)

#write.csv(itol_phylum_df, file = "data/fasttree/Figure5/itol_df.csv", row.names = FALSE)

#itol_phylum_df %>%
#  dplyr::select(OTU, hex, Phylum) %>%
#  write.csv(file = "data/fasttree/Figure5/itol_PHYLUM_df.csv", row.names = FALSE)

itol_FCM_df <- left_join(OTU258_and_FCM, itol_colors, by = "Phylum") %>%
  rename(FCM = Phylum) %>% 
  dplyr::select(OTU, hex, FCM)
#write.csv(itol_FCM_df, file = "data/fasttree/Figure5/itol_FCM_df.csv", row.names = FALSE)


# FOR RL SCORE in iTOL
# Write a file for HNA
#read.csv("data/fasttree/Figure5/OTUs258_MANUAL.csv") %>%
#  dplyr::select(OTU, Muskegon_HNA, Inland_HNA, Michigan_HNA) %>%
#  write.csv(file = "data/fasttree/Figure5/HNA_RLscores.csv", row.names = FALSE)
# Write a file for LNA
#read.csv("data/fasttree/Figure5/OTUs258_MANUAL.csv") %>%
#  dplyr::select(OTU, Muskegon_LNA, Inland_LNA, Michigan_LNA) %>%
#  write.csv(file = "data/fasttree/Figure5/LNA_RLscores.csv", row.names = FALSE)

read.csv("data/fasttree/Figure5/LNA_RLscores.csv") %>%
  dplyr::select(OTU, RL_score) %>%
  rename(LNA_score = RL_score) %>%
#  write.csv(file = "data/fasttree/Figure5/iTOL_LNA_RLscores.csv", row.names = FALSE)

#read.csv("data/fasttree/Figure5/HNA_RLscores.csv") %>%
#  dplyr::select(OTU, RL_score) %>%
#  rename(HNA_score = RL_score) %>%  
#  write.csv(file = "data/fasttree/Figure5/iTOL_HNA_RLscores.csv", row.names = FALSE)

LNA_lake <- read.csv("data/fasttree/Figure5/LNA_RLscores.csv") %>%
  dplyr::select(OTU, lake) %>%
  mutate(lake = as.character(lake)) %>%
  rename(LNA_Lake = lake)
  
HNA_lake <- read.csv("data/fasttree/Figure5/HNA_RLscores.csv") %>%
  dplyr::select(OTU, lake) %>%
  mutate(lake = as.character(lake)) %>%
  rename(HNA_Lake = lake)

OTU_preferred_lake <- HNA_lake %>%
  left_join(LNA_lake, by = "OTU") %>%
  mutate(lake = ifelse(is.na(LNA_Lake), HNA_Lake,
                       ifelse(is.na(HNA_Lake), LNA_Lake,
                              ifelse(HNA_Lake == LNA_Lake, HNA_Lake,
                                     "Mismatch")))) %>%
  dplyr::select(OTU, lake)

itol_lake_colors <- c(
  "Muskegon" = "#FF933F",  
  "Michigan" =  "#EC4863", 
  "Inland" =  "#5C2849",
  "All" = "#8b6914",
  "Muskegon-Inland" = "#FFD3B5",
  "Mismatch" = "#CD0000")  

lake_col_df <- itol_lake_colors %>%
  as.list() %>%
  as.matrix() %>%
  as.data.frame() %>%
  tibble::rownames_to_column("lake") %>%
  rename(color_name = V1) %>%
  mutate(color_name = as.character(color_name))

#OTU_preferred_lake %>%
#  left_join(lake_col_df, by = "lake") %>%
#  dplyr::select(OTU, color_name, lake) %>%
#  write.csv(file = "data/fasttree/Figure5/iTOL_Lake.csv", row.names = FALSE)
```


### How many OTUs per system?
```{r RL-OTU-count, fig.width=5, fig.height=3.5}
# Number of OTUs per system and FCM group
num_OTUs <- c(nrow(dfHNA_musk_scores), nrow(dfLNA_musk_scores), nrow(dfHNA_inland_scores), nrow(dfLNA_inland_scores), 
              nrow(dfHNA_michigan_scores), nrow(dfLNA_michigan_scores))
lake_names <- as.vector(c("Muskegon", "Muskegon", "Inland", "Inland", "Michigan", "Michigan"))
fcm_names <- as.vector(c("HNA", "LNA", "HNA", "LNA", "HNA", "LNA"))

summary_OTU_df <- as.data.frame(num_OTUs) %>%
  mutate(lake = c("Muskegon", "Muskegon", "Inland", "Inland", "Michigan", "Michigan"),
         fcm = c("HNA", "LNA", "HNA", "LNA", "HNA", "LNA"))
summary_OTU_df

ggplot(summary_OTU_df, aes(x = fcm, y = num_OTUs, fill = fcm)) + 
  geom_bar(stat = "identity", color = "black") +
  scale_fill_manual(values = fcm_colors) + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 125)) +
  labs(x = "Flow Cytometry Group", y = "Number of Selected OTUs") + 
  facet_grid(.~lake) + mytheme +
  theme(legend.title = element_blank(), 
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.5, "cm"))
  
```


```{r total-OTUsperLake, fig.width=3.5, fig.height=3}
lake_OTU_nums <- summary_OTU_df %>%
  group_by(lake) %>%
  summarise(sum(num_OTUs))
lake_OTU_nums

ggplot(lake_OTU_nums, aes(x = lake, y = `sum(num_OTUs)`, fill = lake)) + 
  geom_bar(stat = "identity", color = "black") + 
  labs(x = "Lake", y = "Total Number of Selected OTUs") + 
  scale_fill_manual(values = lake_colors) + 
  scale_y_continuous(expand = c(0,0), limits = c(0, 200)) +
  mytheme +
  theme(legend.title = element_blank(), 
        legend.key.width = unit(0.5, "cm"),
        legend.key.height = unit(0.5, "cm"))
```

## Number of OTUs per phylum
```{r num-selectedOTUs}
# How many selected OTUs in total?
nrow(phyfcm_fasttree_df)

# How many selected OTUs are in each Phylum? 
phyfcm_fasttree_df %>%
  mutate(OTU = row.names(.)) %>%
  count(Phylum) %>%
  datatable()

# How many selected OTUs within each phylum are HNA, LNA, or Both? 
phyfcm_fasttree_df %>%
  mutate(OTU = row.names(.)) %>%
  group_by(Phylum) %>%
  count(FCM) %>%
  datatable()
```


### Specific Bacterial Phyla 
```{r num-selectedOTUs-per-phylum}
# Bacteroidetes 
bacteroidetes <- phyfcm_fasttree_df %>%
  mutate(OTU = row.names(.)) %>%
  dplyr::filter(Phylum == "Bacteroidetes") %>%
  count(FCM) %>% 
  mutate(percent = n/sum(n)); bacteroidetes

# Betaproteobacteria 
betaproteobacteria <- phyfcm_fasttree_df %>%
  mutate(OTU = row.names(.)) %>%
  dplyr::filter(Phylum == "Betaproteobacteria") %>%
  count(FCM) %>% 
  mutate(percent = n/sum(n)); betaproteobacteria

# Alphaproteobacteria 
alphaproteobacteria <- phyfcm_fasttree_df %>%
  mutate(OTU = row.names(.)) %>%
  dplyr::filter(Phylum == "Alphaproteobacteria") %>%
  count(FCM) %>% 
  mutate(percent = n/sum(n)); alphaproteobacteria

# Verrucomicrobia 
verrucomicrobia <- phyfcm_fasttree_df %>%
  mutate(OTU = row.names(.)) %>%
  dplyr::filter(Phylum == "Verrucomicrobia") %>%
  count(FCM) %>%
  mutate(percent = n/sum(n)); verrucomicrobia

# How many of the total OTUs were Bacteroidetes
top4_phyla <- sum(bacteroidetes$n)+sum(betaproteobacteria$n)+sum(alphaproteobacteria$n)+sum(verrucomicrobia$n)
sum(top4_phyla)/nrow(phyfcm_fasttree_df) # % of total OTUs selected

# Percent of total selected OTUs by each phylum
sum(bacteroidetes$n)/nrow(phyfcm_fasttree_df) # % of Bacteroidetes 
sum(betaproteobacteria$n)/nrow(phyfcm_fasttree_df) # % of Betaproteobacteria 
sum(alphaproteobacteria$n)/nrow(phyfcm_fasttree_df) # % of Alphaproteobacteria 
sum(verrucomicrobia$n)/nrow(phyfcm_fasttree_df) # % of Verrucomicrobia 
```


# Phylogenetic Signal
## Prepare data 
```{r phylo-sig-dataprep}
# Load in the scores 
LNA_scores_df <- read.csv("data/Figure4/LNA_RLscores.csv") %>%
  dplyr::select(OTU, RL_score) %>%
  rename(LNA_score = RL_score)
HNA_scores_df <- read.csv("data/Figure4/HNA_RLscores.csv") %>%
  dplyr::select(OTU, RL_score) %>%
  rename(HNA_score = RL_score)
stopifnot(dim(LNA_scores_df) == dim(HNA_scores_df))

# Put them into one data frame
summarized_RL_scores <- HNA_scores_df %>%
  left_join(LNA_scores_df, by = "OTU") 

# For simpliclity, make sure the vectors of OTUs match the OTU order in the phylogeny
summarized_RL_scores <- summarized_RL_scores[match(rooted_tree$tip.label, summarized_RL_scores$OTU),]
stopifnot(rooted_tree$tip.label == summarized_RL_scores$OTU)

# Load FCM data that is categorical
FCM_categorical_df <- read.csv("data/Figure4/OTUs258_MANUAL.csv") %>%
   dplyr::select(OTU, FCM)
FCM_categorical_df <- FCM_categorical_df[match(rooted_tree$tip.label, FCM_categorical_df$OTU),]
stopifnot(rooted_tree$tip.label == FCM_categorical_df$OTU)

####### TREEs for only HNA and LNA
# HNA: Subset all of the HNA OTUs
HNA_df_phydist <- summarized_RL_scores %>%
  select(OTU, HNA_score) %>%
  na.omit()
HNAscores <- HNA_df_phydist$HNA_score
names(HNAscores) <- HNA_df_phydist$OTU
# Subset the larger tree to only have the HNA OTUs
HNA_rooted_tree <- ape::drop.tip(phy = rooted_tree, tip = rooted_tree$tip.label[-match(HNA_df_phydist$OTU, rooted_tree$tip.label)])
# Make sure OTUs are in the same order for the test 
HNA_df_phydist <- HNA_df_phydist[match(HNA_rooted_tree$tip.label, HNA_df_phydist$OTU),]
stopifnot(HNA_df_phydist$OTU == HNA_rooted_tree$tip.label)
stopifnot(names(HNAscores) == HNA_rooted_tree$tip.label)

# LNA: Subset all of the HNA OTUs
LNA_df_phydist <- summarized_RL_scores %>%
  select(OTU, LNA_score) %>%
  na.omit()
LNAscores <- LNA_df_phydist$LNA_score
names(LNAscores) <- LNA_df_phydist$OTU
# Subset the larger tree to only have the LNA OTUs
LNA_rooted_tree <- ape::drop.tip(phy = rooted_tree, tip = rooted_tree$tip.label[-match(LNA_df_phydist$OTU, rooted_tree$tip.label)])
# Make sure OTUs are in the same order for the test 
LNA_df_phydist <- LNA_df_phydist[match(LNA_rooted_tree$tip.label, LNA_df_phydist$OTU),]
stopifnot(LNA_df_phydist$OTU == LNA_rooted_tree$tip.label)
stopifnot(names(LNAscores) == LNA_rooted_tree$tip.label)
```

## Pagel's Lambda
### Discrete Character Evolution
```{r discrete-phylosig}
# Discrete models: From Samantha Price & Roi Holzman: http://www.eve.ucdavis.edu/~wainwrightlab/Roi/Site/Teaching_files/Intro2Phylo_S4.R
discrete_FCM <- FCM_categorical_df$FCM
names(discrete_FCM) <- FCM_categorical_df$OTU

# Discrete Pagel's Lambda Model
discrete_lambda_fit <- fitDiscrete(rooted_tree, discrete_FCM, treeTransform = "lambda")

# To test for significant phylogenetic signal, compare the negative log likelihood when there is no signal with rescale
lambda0_tree <- rescale(rooted_tree, "lambda", 0) # A big polytomy tree 
lambda0_fit <- fitDiscrete(lambda0_tree, discrete_FCM)

# Is there a significant difference? NO 
# Using a likelihood ratio test
pchisq(2*(lambda0_fit$opt$lnL-discrete_lambda_fit$opt$lnL), 1, lower.tail=FALSE) 
```

### Continuous Character Evolution  
From [Roi Holzman & Samantha Price](http://www.eve.ucdavis.edu/~wainwrightlab/Roi/Site/Teaching_files/Intro2Phylo_S5.R):  

- Pagel's lambda is a tree transformation that assesses the degree of phylogenetic signal within the trait by multiplying the internal branches of the tree by values between 0 and 1 (the lambda parameter).  
    - lambda=1 indicates complete phylogenetic patterning as it returns the branch lengths untransformed.  
    - lambda=0 indicates no patterning as it leads the tree collapsing to a single large polytomy.  

```{r pagels-lambda}
# # We chose HNA and LNA RL Score as the trait we are testing for phylogenetic signal, with 999 randomizations:
# Does the HNA RL Score have phylogenetic signal?
phylosig(HNA_rooted_tree, HNAscores, method = "lambda", test = TRUE, nsim = 999)
# Does the LNA RL Score have phylogenetic signal?
phylosig(LNA_rooted_tree, LNAscores, method = "lambda", test = TRUE, nsim = 999)
```

## Blomberg's K
```{r blombergs-k}
# HNA
phylosig(tree = rooted_tree, x = HNAscores, method = "K", test = TRUE, nsim = 999)

# LNA
phylosig(tree = rooted_tree, x = LNAscores, method = "K", test = TRUE, nsim = 999)
```

## Moran's I
```{r morans-I, fig.width=3,fig.height=3}
# HNA: Calculate the pairwise distances of the OTUs in the HNA phylogeny
HNA_rooted_phy_dist <- cophenetic(HNA_rooted_tree)

# Do HNA OTUs have phylogenetic autocorrelation with the Moran's I test?
moran_HNA_test <- abouheif.moran(x = HNA_df_phydist$HNA_score, W = HNA_rooted_phy_dist, method = "Abouheif", nrepet = 999)
moran_HNA_test

# LNA: Calculate the pairwise distances of the OTUs in the HNA phylogeny
LNA_rooted_phy_dist <- cophenetic(LNA_rooted_tree)

# Do LNA OTUs have phylogenetic autocorrelation with the Moran's I test?
moran_LNA_test <- abouheif.moran(x = LNA_df_phydist$LNA_score, W = LNA_rooted_phy_dist, method = "Abouheif", nrepet = 999)
moran_LNA_test
```

## Abouheif's Cmean
```{r abouheif-C, fig.width=3,fig.height=3}
# HNA: Perform an Abouheif moran test using Monte Carlo simulations (default is 999 randomizations)
abouheif_HNA_test <- abouheif.moran(x = HNA_df_phydist$HNA_score, W = HNA_rooted_phy_dist, method = "oriAbouheif", nrepet = 999)
abouheif_HNA_test

# LNA: Perform an Abouheifmoran test using Monte Carlo simulations (default is 999 randomizations)
abouheif_LNA_test <- abouheif.moran(x = LNA_df_phydist$LNA_score, W = LNA_rooted_phy_dist, method = "oriAbouheif", nrepet = 999)
abouheif_LNA_test
```

# Session Information 
```{r session-info}
devtools::session_info() # This will include session info with all R package version information
```

